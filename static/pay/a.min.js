demo.access("$vx", demo.fn("demo_vx")), new VConsole();
let api = window.location.origin + "/api/",
  urls = {
    open: "com/common/get_openid",
    code: "com/common/get_share",
    pay: "parents/My/payParentsOrder"
  },
  vp = demo.$session.get("wx-pay-config", {}),
  params = demo.getUrl();
demo
  .cssLazy()
  .text(
    "#index,body{width:100vw;height:100vh}header{height:50px;padding:5px;box-sizing:border-box;line-height:40px;text-align:center;color:#fff;background-color:#04be02;letter-spacing:1px;font-size:18px}.box{height:calc(100% - 130px);width:85%;margin:0 auto;box-sizing:border-box;font-size:15px}h1{line-height:1.2;padding:10% 10px 15px;text-align:center;font-weight:700;letter-spacing:1px}.b{margin:10px 0}.b p{color:#999;margin-bottom:5px}.btn{text-align:center;margin-top:15px}.btn .m_btn{min-width:80px}.btn .m_btn + .m_btn{margin-left:20px}"
  );
let a1 = demo._div(
    "h1",
    "",
    "你正在支付一笔由 [幼儿园] 发起的 [宝贝在线播放] 订单"
  ),
  a2 = demo._div("div", "b", "正在查询订单状态，请稍后。。。"),
  a3 = demo._div("div", "btn");
demo.js("#index .box").appendChild(a1),
  demo.js("#index .box").appendChild(a2),
  demo.js("#index .box").appendChild(a3);
let dom = demo.js("#index .box .b"),
  template = function(e) {
    let t = [
      '<p class="num">订单号： <b>' + e.order_no + "</b></p>",
      '<p class="status">订单状态： <b id="status">待支付</b></p>',
      '<p class="price">订单价格： ￥<b>' +
        (e.money / 100).toFixed(2) +
        "</b></p>"
    ];
    return btns(2), t.join("");
  },
  error = function(e) {
    dom.addClass("col_danger"), dom.html(e), demo.toast(e);
  },
  btns = function(e) {
    let t = demo.js("#index .btn"),
      o = ['<button class="m_btn bgc_purple small" id="ret">返回</button>'];
    2 === e &&
      o.push(
        '<button class="m_btn bgc_green small" id="reset">重新支付</button>'
      ),
      t.html(o.join("")),
      setTimeout(function() {
        demo.js("#ret").click(function() {
          let e = params.state.split("_0_");
          window.location.replace(decodeURIComponent(e[4]));
        }),
          demo.js("#reset").click(function() {
            let e = params.state.split("_0_");
            (params = { t: e[1], n: e[2], id: e[3], u: e[4] }),
              init(demo.$session.get("wx-pay-config", {}));
          });
      }, 500);
  };
btns(0);
let init = function(e) {
  if (params.state) {
    let e = params.state.split("_0_");
    demo.ajax(api + urls.open).post({ js_code: params.code, n_id: "0" }, t => {
      if (200 === t.code) {
        if (t.data.errmsg) return demo.toast(t.data.errmsg);
        let o = t.data.openid;
        demo
          .ajax(api + urls.pay)
          .post(
            {
              access_token: e[1] || "",
              order_sn: e[2] || "",
              openid: o,
              n_id: e[3] || ""
            },
            e => {
              if (200 === e.code) {
                let t = e.data.jsApi_request;
                dom.html(template(e.data));
                let o = demo.js("#status");
                demo.$vx().pay(t, e => {
                  e.code ? (o.html("支付成功"), btns(0)) : o.html(e.err);
                });
              } else error(e.msg);
            }
          );
      } else error(t.msg);
    });
  } else
    demo.$vx().plug({ type: "default", key: e }, t => {
      if (t.code) {
        let t = e.strAppId ? { component_appid: "wx55b8471985fa8e81" } : {};
        demo
          .$vx()
          .auth({
            data:
              "t_0_" +
              params.t +
              "_0_" +
              params.n +
              "_0_" +
              params.id +
              "_0_" +
              params.u,
            type: 1,
            ...t
          });
      }
    });
};
vp.url
  ? init(vp)
  : demo.ajax(api + urls.code).post({ n_id: "0" }, e => {
      200 === e.code
        ? (demo.$session.set("wx-pay-config", e.data), init(e.data))
        : error(e.msg);
    });
